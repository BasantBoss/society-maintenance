<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Society Maintenance</title>
  <link rel="manifest" href="/manifest.json">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Society</a>
    </div>
  </nav>

  <main class="container py-4">
    <div id="auth" class="mb-3">
      <h4>Login</h4>
      <div class="mb-2"><input id="username" placeholder="username" class="form-control"></div>
      <div class="mb-2"><input id="password" placeholder="password" type="password" class="form-control"></div>
      <button id="btnLogin" class="btn btn-primary">Login</button>
      <div id="loginStatus" class="mt-2 text-danger"></div>
    </div>

    <div id="app" style="display:none;">
      <h4>Create Maintenance Request</h4>
      <input id="title" placeholder="Title" class="form-control mb-2">
      <textarea id="desc" placeholder="Describe issue" class="form-control mb-2"></textarea>
      <button id="create" class="btn btn-success mb-3">Create</button>

      <h4>Requests</h4>
      <ul id="requests" class="list-group"></ul>
    </div>
  </main>

  <script>
    const apiBase = localStorage.getItem('apiBase') || (location.origin);
    async function login() {
      const u = document.getElementById('username').value;
      const p = document.getElementById('password').value;
      const res = await fetch(apiBase + '/api/auth/login', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username:u,password:p})
      });
      if (!res.ok) { document.getElementById('loginStatus').innerText = 'Login failed'; return; }
      const data = await res.json();
      localStorage.setItem('token', data.token);
      document.getElementById('auth').style.display='none';
      document.getElementById('app').style.display='block';
      loadRequests();
    }
    async function createReq() {
      const title = document.getElementById('title').value;
      const desc = document.getElementById('desc').value;
      const res = await fetch(apiBase + '/api/maintenance', {
        method:'POST',
        headers: { 'Content-Type':'application/json', 'Authorization':'Bearer ' + localStorage.getItem('token') },
        body: JSON.stringify({title, description: desc})
      });
      if (res.ok) { document.getElementById('title').value=''; document.getElementById('desc').value=''; loadRequests(); }
    }
    async function loadRequests() {
      const res = await fetch(apiBase + '/api/maintenance', {
        headers: { 'Authorization':'Bearer ' + localStorage.getItem('token') }
      });
      if (!res.ok) return;
      const list = await res.json();
      const ul = document.getElementById('requests');
      ul.innerHTML = '';
      list.forEach(r => {
        const li = document.createElement('li');
        li.className = 'list-group-item';
        li.innerHTML = `<strong>${r.title}</strong><div>${r.description||''}</div><small>${new Date(r.createdAt).toLocaleString()}</small>`;
        ul.appendChild(li);
      });
    }
    document.getElementById('btnLogin').addEventListener('click', login);
    document.getElementById('create').addEventListener('click', createReq);
  </script>
</body>
</html>